# HuRAG WebUI

## 简介

这是 HuRAG 项目的 WebUI 内建前端应用，以 ChatBot 的形式提供基于知识库的解读问答应用，主要内容为 RAG 项目中的生成（generation）阶段逻辑和 Web 前端。

## 安装

本项目需要访问 MySQL/MariaDB 数据库和 HuRAG Python SDK，即 `hurag` 库，使用 uv 管理 Python 环境，Python 版本 3.12，请先确认上述环境已经具备。

*注意：默认 `hurag` 库以可编辑方式安装在和本项目所在目录同级的另一个目录 `HuRAG` 中，安装本项目前请确认，如果不在此目录中，需要修改本项目的 `pyproject.toml` 配置文件中 `[uv.tool.sources]` 使之指向 `hurag` 库的安装目录。*

安装方法：克隆项目库并同步 uv 环境。

```bash
mkdir -p /path/to/installation
cd /path/to/installation
git clone https://github.com/QuestYard/hurag-webui.git
cd /path/to/installation/hurag-webui
uv sync --no-dev
```

### 配置文件

运行 HuRAG WebUI 需要配置环境变量和配置文件。

#### 环境变量

项目使用 `.webui.env` 存放环境变量，需要配置的内容为：

```bash
MATPLOTLIB = "false"
STORAGE_SECRET = "a token string generated by webui-token"
```

其中 `STORAGE_SECRET` 变量的值可以运行代码库中的 `webui-token` 脚本生成：

```bash
cd /path/to/installation/hurag-webui

# MacOS/Linux
./webui-token.sh

# Windows
./webui-token.ps1
```

#### 配置文件

项目使用 `webui-config.yaml` 作为配置文件，需要配置的内容为：

```yaml
# Configurations for HuRAG WebUI application

# MariaDB/MySQL database connector
mariadb:
  host:       localhost             # 数据库服务器地址
  port:       3306                  # 数据库服务器端口
  user:       <db-user>             # 数据库用户名
  password:   <password>            # 数据库用户密码
  database:   <db-name>             # 数据库名称，例如 hurag_webui

# Dependencies
services:
  sso:        <sso-endpoint>        # 单点登录服务端点，不配置则默认使用内建 SSO 服务
  ctx_size:   <tiny|medium|large>   # LLM 上下文长度，4K 以内为 tiny，8K 以内建议 medium，大于 8K 为 large
```

*注意：本项目的配置文件 `webui-config.yaml` 必须和 `hurag` 库的配置文件 `hurag.yaml` 在同一目录下。*

### 初始化数据库

项目安装后，激活虚拟环境，使用命令 `init-db` 初始化 WebUI 的数据库。此命令也可用于清空重建数据库。

```bash
cd /path/to/installation-directory
# MacOS/Linux
source .venv/bin/activate
# Windows
./venv/Scripts/activate
cd /path/to/working-dirctory
init-db
```

## 启动应用

**开发模式**

使用命令 `python -m hurag.webui` 以开发模式启动 HuRAG WebUI 应用。此模式下，应用会监听代码和模板文件的变更，适合开发调试使用。

**生产模式**

生产模式部署启动推荐使用 `gunicorn`，并配置为守护进程运行。

项目的工作目录必须和 `hurag` 库的工作目录为同一个，或者在工作目录中放置正确的 `hurag` 库配置文件，包括 `hurag.yaml`, `.env`, `kgraph.toml` 等。如果应用使用内置的简易 SSO 服务，还需要在工作目录中放置 `native_sso.csv` 文件，用于存放用户信息。

`native_sso.csv` 文件的格式为 CSV，第一行为表头，后续行为用户信息，示例如项目根目录中的 `native_sso.csv` 文件：[native_sso.csv](./native_sso.csv)  

### Systemd 服务配置

在项目根目录下的 `hurag_webui.service.1` 文件提供了一个 `systemd` 服务单元文件的示例，可将其复制到工作目录，修改其中的工作目录和 `gunicorn` 运行目录，并配置为系统服务。

需要修改的内容包括：

- `WorkingDirectory=` 行，修改为 HuRAG WebUI 项目的工作目录。
- `ExecStart=` 行，修改为 `gunicorn` 可执行文件的路径，通常为项目虚拟环境中的 `gunicorn` 可执行文件路径。

其他配置信息，如监听端口（默认8088）根据需要进行调整。

配置并启动系统服务的命令如下：

```bash
# 复制服务单元文件到工作目录
cp /path/to/installation/hurag-webui/hurag_webui.service.1 /path/to/working-directory/hurag_webui.service
# 编辑 hurag_webui.service 文件，修改 WorkingDirectory 和 ExecStart 行
# 将服务单元文件链接到 systemd 目录
sudo ln -s /path/to/working-directory/hurag_webui.service /etc/systemd/system/hurag_webui.service
sudo systemctl daemon-reload
sudo systemctl start hurag_webui.service
sudo systemctl enable hurag_webui.service
```
